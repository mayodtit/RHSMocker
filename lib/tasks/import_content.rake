require 'nokogiri'
require 'html/sanitizer'
include Math # for padding

namespace :admin do
  task :import_content => :environment do |t, args|
    skipped = []
    failed = []

    filenames = Dir.glob(args.extras.try(:any?) ? args.extras : './db/mayo_content/*.xml')
    num_files = filenames.count
    padding = Math::log10(num_files).ceil

    disable_solr if num_files > 1000

    filenames.each_with_index do |filename, i|
      log("Processing file #{(i + 1).to_s.rjust(padding)}/#{num_files}: #{filename}")
      importer = ContentImporter.new(Nokogiri::XML(File.open(filename)), logger)
      case importer.import
      when :skipped
        skipped << filename
      when :failed
        failed << filename
      end
    end

    enable_solr if num_files > 1000

    log("Skipped #{skipped.count} files:")
    skipped.each{|f| log("  #{f}")}
    log("Failed to process #{failed.count} files:")
    failed.each{|f| log("  #{f}")}
    log("Re-run failed: rake admin:import_content[#{failed.join(',')}]") if failed.any?
  end

  task seed_general_program: :environment do |t, args|
    @program = Program.find_by_title('General')
    unless @program
      @program = Program.create!(title: 'General')
      general_document_ids.each do |document_id|
        content = Content.find_by_document_id(document_id)
        next unless content
        @program.program_resources.create!(resource: content)
      end
    end
  end

  private

  def log(message)
    logger.info(message)
    puts(message)
  end

  def logger
    @logger ||= Logger.new('./log/import_content.log')
  end

  def disable_solr
    Sunspot.session = Sunspot::Rails::StubSessionProxy.new(Sunspot.session)
  end

  def enable_solr
    log("Re-indexing Solr for new Content, this could take a little while...")
    Sunspot.session = Sunspot.session.original_session
    Content.reindex
    Sunspot.commit
  end

  def general_document_ids
    %w(AN00638 DG00014 HQ01273 MY01693 MY01186 SR00042 MH00078 HT00510 HT00486
       HT00329 HT00520 AN01835 HQ01514 HT00509 MY01020 MY00946 HT00345 AN01483
       HT00530 AN02056 MY01344 AN01508 HT00327 AN02038 HT00025 AN02129 HT00001
       HT00063 HT00003 WL00010 HT00419 HT00494 HT00408 HT00051 HT00410 HT00352
       HT00540 HT00597 HT00344 HT00416 HT00472 AN01481 AN02188 AN01905 AN02073
       FL00075 HT00414 HT00422 HT00356 AN00947 AN01818 AN02086 AN01782 AN01144
       AN01740 AN00065 AN01705 AN01837 ID00002 DE00003 HQ00407 WO00020 DE00001
       HT00347 HT00140 HT00084 HT00139 HT00099 HT00346 HT00143 HT00145 HT00428
       HT00142 HT00473 HT00136 HT00418 HT00403 AN01861 AN00652 HT00027 AN02149
       HT00441 HT00537 HT00431 HT00430 HT00559 HT00389 AN01878 MY00186 MY00814
       MY01072 MY00195 HT00493 HT00653 HT00646 HT00583 HT00578 HT00644 HT00577
       HT00641 HT00581 HT00585 HT00584 HT00590 HT00161 HT00582 HT00592 HT00579
       HT00587 WO00098 MY00657 WO00069 HQ00324 HT00543 AN01455 AN01238 AA00060
       ID00036 ID00017 HT00315 HT00340 HT00337 HT00339 HT00411 HT00317 HT00341
       HT00413 HT00316 HT00342 HT00409 HT00343 AN01229 MY00743 HT00425 HT00227
       HT00088 HT00111 HT00483 HT00089 HT00101 HT00481 HT00475 HT00106
       AN01716 AN01688 AN02016 AN01440 SN00003 SN00039 MC00020 MY01350
       HT00482 HT00478 HT00319 HT00384 HT00092 HT00091 HT00355 HT00096
       HT00385 HT00100 HT00083 HT00081 HT00480 HT00087 AN02154 HT00484
       SN00042 HT00531 SR00001 WL00062 SR00032 SR00031 SR00034 HT00606
       HT00508 HT00255 HT00157 HT00602 HT00607 HT00563 HT00604 SR00007
       HQ01070 HA00084 SA00044 NU00198 HT00555 HT00627 HT00629 HT00412
       HT00600 HT00505 HT00634 HT00371 HT00490 HT00630 HT00625 HT00511
       HT00376 AN02194 HQ01596 HT00002 MY00245 WL00056 HT00517 HT00560
       HT00548 SR00030 AN01024 AN02098 AN01487 AN01938 AN01866 AN02031
       AN00589 AN01765 AN01428 AN01755 AN02046 AN01639 AN01501 AN01980
       AN01836 AN01830 AN01974 AN01640 AN01867 AN00576 AN01658 AN01933
       AN00348 AN02122 AN01810 AN02057 AN01403 AN01955 AN00835 AN01732
       AN01754 AN01097 AN01598 AN01738 AN01334 AN01251 AN01774 AN01552
       AN02191 AN01906 AN01770 AN01638 AN01354 AN01700 AN02108 AN01592
       AN01772 AN02160 AN02140 AN00832 AN01582 AN02168 AN01968 AN01812
       AN01261 AN02130 AN01856 AN02047 AN00389 AN01423 AN01801 AN01863
       AN01800 AN01294 AN01849 AN01665 NU00189 AN00284 AN01303 AN01006
       AN01661 AN01142 AN02167 AN00896 AN02193 AN01588 AN02088 AN02175
       AN01620 AN00317 AN02128 HQ01487 AN01981 AN01281 AN01776 AN01602
       AN01713 AN02071 AN01289 AN01512 AN02159 AN02065 AN01781 AN01497
       AN02185 AN00637 AN01953 AN02189 AN02119 AN00792 AN02030 AN00130
       AN02052 AN01664 AN02060 AN01734 AN01865 AN01095 AN00893 AN01119
       AN02120 HQ00608 AN01858 AN01023 AN01798 AN02082 AN01857 AN01037
       AN02075 AN01258 AN01063 AN02053 AN00968 AN02107 AN00420 AN01947
       AN00357 AN01563 AN00567 AN01543 AN02192 AN00591 AN01227 SA00103
       NU00283 WT00006 HQ00076 HB00089 MY00996 MY01084 HQ00316 HQ01387
       NU00204 MY01092 NU00600 MY00845 SM00025 MH00125 SN00010 SM00067
       CA00078 NU00033 NU00202 NU00260 MH00131 HA00040 SN00049 SM00059
       HQ01217_D GA00053 GA00042 SM00086 HE00014 MY01377 SM00110 MH00128
       HQ00694_D SA00082 SR00009 MH00129 HQ01681 CL00015 NU00585 SC00024
       MY01357 MC00013 CC00023 HQ01707 MY01458 MY01594 MY01540 NU00196
       SM00115 MY01373 WL00051 MY01268 MY01399 MY01387 SM00085_D CL00011
       MY00752 SM00071 DA00073 SM00028 HA00001 MY01383 HQ01543 HQ00885_D
       HQ01676 SL00010 HQ01447 HQ00474 HQ01627 MH00042 HO00075 HB00039
       MY02124 MY01378 MY02122 CL00032 NU00255 SA00087 HQ01556_D HQ01305
       MY01416 NU00262 NU00641 MH00102 MY00073 MY01460 MY00731 MH00075
       HQ01710 SM00056_D HB00085 NU00284 SL00016 NU00584 HQ01612 HQ00594_D
       PN00001 CM00004 SM00113 EP00002 NU00293 HQ00171 HB00087 NU00197
       NU00190 SR00043 SM00062_D WO00014 MY00753 MY01188 HT00396 HT00660
       HT00401 HT00427 HT00036 HT00519 HT00224 HT00532 HT00353 HT00545
       HT00213 HT00218 HT00562 HT00575 HT00348 HT00677 HT00007 HT00023
       HT00050 HT00320 HT00525 HT00469 HT00681 HT00547 HT00679 HT00047
       HT00230 HT00074 HT00391 HT00028 HT00228 HT00568 HT00052 HT00203
       HT00576 HT00033 HT00212 HT00071 HT00076 HT00048 HT00466 HT00238
       HT00049 HT00424 HT00399 HT00141 HT00477 HT00655 HT00405 HT00518
       HT00571 HT00307 HT00075 HT00231 HT00599 HT00557 HT00569 HT00206
       HT00460 HT00667 HT00209 HT00671 HT00437 HT00242 HT00656 HT00642
       HT00221 HT00680 HT00226 HT00465 HT00461 HT00654 HT00160 HT00011
       HT00030 HT00516 HT00102 HT00669 HT00158 HT00603 HT00652 HT00216
       HT00515 HT00426 HT00462 HT00615 HT00586 HT00608 HT00651 HT00500
       HT00442 HT00055 HT00214 HT00207 HT00031 HT00223 HT00421 HT00533
       HT00438 HT00383 HT00674 HT00044 HT00565 HT00558 HT00241 HT00397
       HT00394 HT00552 HT00026 HT00215 HT00657 HT00393 HT00029 HT00678
       HT00349 HT00162 HT00219 HT00683 HT00392 HT00159 HT00613 HT00211
       HT00239 HT00222 HT00553 HT00350 HT00240 HT00220 HT00072 HT00675
       HT00205 HT00035 HT00467 HT00390 HT00398 HT00208 HT00233 HT00225
       HT00237 HT00496 HT00567 HT00332 HT00464 HT00470 HT00534 HT00648
       HT00439 HT00497 HT00053 HT00701 HT00542 HT00232 HT00210 HT00440
       HT00236 HT00513 HT00617 HT00501 HT00527 HT00676 HT00564 HT00468
       HT00235 HT00378 HT00064 HT00551 HT00406 HT00601 HT00032 HT00379
       HT00079 HT00004 HT00549 HT00328 HT00400 HT00574 HT00402 HT00434
       HT00404 HT00229 HT00594 NU00200 NU00201 AN01211 MY01559)
  end
end
